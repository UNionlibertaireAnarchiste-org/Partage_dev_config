name: Auto-merge PR approuvées

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    if: github.event.review.state == 'approved' || github.event.check_suite.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
    - name: Auto-merge si conditions remplies
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          // Auto-merge pour les PR avec tous les tests passés
          if (context.eventName === 'check_suite' && context.payload.check_suite.conclusion === 'success') {
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const pr of prs) {
              // Vérifier si pas de labels bloquants
              const hasBlockingLabels = pr.labels.some(label => 
                ['work-in-progress', 'do-not-merge', 'draft'].includes(label.name)
              );
              
              if (!hasBlockingLabels && pr.user.login === 'AnARCHIS12') {
                try {
                  await github.rest.pulls.merge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    merge_method: 'squash'
                  });
                  console.log(`PR #${pr.number} mergée automatiquement`);
                } catch (error) {
                  console.log(`Auto-merge PR #${pr.number} échoué:`, error.message);
                }
              }
            }
          }